

<!DOCTYPE html>
<html lang="en">
<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>
      StorageAdapter.js - Documentation
  </title>

  <link href="https://www.braintreepayments.com/images/favicon-ccda0b14.png" rel="icon" type="image/png">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.7.0/highlight.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlightjs-line-numbers.js/2.3.0/highlightjs-line-numbers.min.js"></script>
  <script>
    hljs.initHighlightingOnLoad();
  </script>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>

  <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
  <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
  <link type="text/css" rel="stylesheet" href="styles/monokai-sublime.css">

  

  <!-- start Mixpanel -->
  <script type="text/javascript">(function(e,a){if(!a.__SV){var b=window;try{var c,l,i,j=b.location,g=j.hash;c=function(a,b){return(l=a.match(RegExp(b+"=([^&]*)")))?l[1]:null};g&&c(g,"state")&&(i=JSON.parse(decodeURIComponent(c(g,"state"))),"mpeditor"===i.action&&(b.sessionStorage.setItem("_mpcehash",g),history.replaceState(i.desiredHash||"",e.title,j.pathname+j.search)))}catch(m){}var k,h;window.mixpanel=a;a._i=[];a.init=function(b,c,f){function e(b,a){var c=a.split(".");2==c.length&&(b=b[c[0]],a=c[1]);b[a]=function(){b.push([a].concat(Array.prototype.slice.call(arguments,
  0)))}}var d=a;"undefined"!==typeof f?d=a[f]=[]:f="mixpanel";d.people=d.people||[];d.toString=function(b){var a="mixpanel";"mixpanel"!==f&&(a+="."+f);b||(a+=" (stub)");return a};d.people.toString=function(){return d.toString(1)+".people (stub)"};k="disable time_event track track_pageview track_links track_forms register register_once alias unregister identify name_tag set_config reset people.set people.set_once people.increment people.append people.union people.track_charge people.clear_charges people.delete_user".split(" ");
  for(h=0;h<k.length;h++)e(d,k[h]);a._i.push([b,c,f])};a.__SV=1.2;b=e.createElement("script");b.type="text/javascript";b.async=!0;b.src="undefined"!==typeof MIXPANEL_CUSTOM_LIB_URL?MIXPANEL_CUSTOM_LIB_URL:"file:"===e.location.protocol&&"//cdn.mxpnl.com/libs/mixpanel-2-latest.min.js".match(/^\/\//)?"https://cdn.mxpnl.com/libs/mixpanel-2-latest.min.js":"//cdn.mxpnl.com/libs/mixpanel-2-latest.min.js";c=e.getElementsByTagName("script")[0];c.parentNode.insertBefore(b,c)}})(document,window.mixpanel||[]);
  mixpanel.init("1919205b2da72e4da3b9b6639b444d59");</script>
  <!-- end Mixpanel -->
</head>

<body>
  <svg style="display: none;">
    <defs>
      <symbol id="linkIcon" fill="#706d77" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
          <path d="M0 0h24v24H0z" fill="none"/>
          <path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76 0 5-2.24 5-5s-2.24-5-5-5z"/>
      </symbol>
    </defs>
  </svg>

  <input type="checkbox" id="nav-trigger" class="nav-trigger" />
  <label for="nav-trigger" class="navicon-button x">
    <div class="navicon"></div>
  </label>

  <label for="nav-trigger" class="overlay"></label>

  <div class="top-nav-wrapper">
    <ul>
      <li >
        <a href="index.html">
          
            <svg fill="#6D6D6D" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
              <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>
              <path d="M0 0h24v24H0z" fill="none"/>
            </svg>
          
          
        </a>
      </li>

      

    </ul>
  </div>

  <nav>
    <h3 class="reference-title">
      OIP HDMW
    </h3>

    <h3>Classes</h3><ul><li id="Account-nav"><a href="Account.html">Account</a><ul class='methods'><li data-type="method" id="Account-_handleWalletWebsocketUpdate-nav"><a href="Account.html#_handleWalletWebsocketUpdate">_handleWalletWebsocketUpdate</a></li><li data-type="method" id="Account-create-nav"><a href="Account.html#create">create</a></li><li data-type="method" id="Account-getPaymentBuilder-nav"><a href="Account.html#getPaymentBuilder">getPaymentBuilder</a></li><li data-type="method" id="Account-getSetting-nav"><a href="Account.html#getSetting">getSetting</a></li><li data-type="method" id="Account-login-nav"><a href="Account.html#login">login</a></li><li data-type="method" id="Account-logout-nav"><a href="Account.html#logout">logout</a></li><li data-type="method" id="Account-onWalletWebsocketUpdate-nav"><a href="Account.html#onWalletWebsocketUpdate">onWalletWebsocketUpdate</a></li><li data-type="method" id="Account-payForArtifactFile-nav"><a href="Account.html#payForArtifactFile">payForArtifactFile</a></li><li data-type="method" id="Account-sendArtifactTip-nav"><a href="Account.html#sendArtifactTip">sendArtifactTip</a></li><li data-type="method" id="Account-setSetting-nav"><a href="Account.html#setSetting">setSetting</a></li><li data-type="method" id="Account-store-nav"><a href="Account.html#store">store</a></li></ul></li><li id="ArtifactPaymentBuilder-nav"><a href="ArtifactPaymentBuilder.html">ArtifactPaymentBuilder</a><ul class='methods'><li data-type="method" id="ArtifactPaymentBuilder-_swapCoinTickerName-nav"><a href="ArtifactPaymentBuilder.html#_swapCoinTickerName">_swapCoinTickerName</a></li><li data-type="method" id="ArtifactPaymentBuilder-coinPicker-nav"><a href="ArtifactPaymentBuilder.html#coinPicker">coinPicker</a></li><li data-type="method" id="ArtifactPaymentBuilder-fiatToCrypto-nav"><a href="ArtifactPaymentBuilder.html#fiatToCrypto">fiatToCrypto</a></li><li data-type="method" id="ArtifactPaymentBuilder-getPaymentAdddressAndAmount-nav"><a href="ArtifactPaymentBuilder.html#getPaymentAdddressAndAmount">getPaymentAdddressAndAmount</a></li><li data-type="method" id="ArtifactPaymentBuilder-getPaymentAddress-nav"><a href="ArtifactPaymentBuilder.html#getPaymentAddress">getPaymentAddress</a></li><li data-type="method" id="ArtifactPaymentBuilder-getPaymentAddresses-nav"><a href="ArtifactPaymentBuilder.html#getPaymentAddresses">getPaymentAddresses</a></li><li data-type="method" id="ArtifactPaymentBuilder-getPaymentAmount-nav"><a href="ArtifactPaymentBuilder.html#getPaymentAmount">getPaymentAmount</a></li><li data-type="method" id="ArtifactPaymentBuilder-getSupportedCoins-nav"><a href="ArtifactPaymentBuilder.html#getSupportedCoins">getSupportedCoins</a></li><li data-type="method" id="ArtifactPaymentBuilder-nameToTicker-nav"><a href="ArtifactPaymentBuilder.html#nameToTicker">nameToTicker</a></li><li data-type="method" id="ArtifactPaymentBuilder-pay-nav"><a href="ArtifactPaymentBuilder.html#pay">pay</a></li><li data-type="method" id="ArtifactPaymentBuilder-sendPayment-nav"><a href="ArtifactPaymentBuilder.html#sendPayment">sendPayment</a></li><li data-type="method" id="ArtifactPaymentBuilder-tickerToName-nav"><a href="ArtifactPaymentBuilder.html#tickerToName">tickerToName</a></li></ul></li><li id="KeystoreStorageAdapter-nav"><a href="KeystoreStorageAdapter.html">KeystoreStorageAdapter</a><ul class='methods'><li data-type="method" id="KeystoreStorageAdapter-_save-nav"><a href="KeystoreStorageAdapter.html#_save">_save</a></li><li data-type="method" id="KeystoreStorageAdapter-check-nav"><a href="KeystoreStorageAdapter.html#check">check</a></li><li data-type="method" id="KeystoreStorageAdapter-create-nav"><a href="KeystoreStorageAdapter.html#create">create</a></li><li data-type="method" id="KeystoreStorageAdapter-decrypt-nav"><a href="KeystoreStorageAdapter.html#decrypt">decrypt</a></li><li data-type="method" id="KeystoreStorageAdapter-encrypt-nav"><a href="KeystoreStorageAdapter.html#encrypt">encrypt</a></li><li data-type="method" id="KeystoreStorageAdapter-generateIdentifier-nav"><a href="KeystoreStorageAdapter.html#generateIdentifier">generateIdentifier</a></li><li data-type="method" id="KeystoreStorageAdapter-load-nav"><a href="KeystoreStorageAdapter.html#load">load</a></li><li data-type="method" id="KeystoreStorageAdapter-save-nav"><a href="KeystoreStorageAdapter.html#save">save</a></li></ul></li><li id="LocalStorageAdapter-nav"><a href="LocalStorageAdapter.html">LocalStorageAdapter</a><ul class='methods'><li data-type="method" id="LocalStorageAdapter-_save-nav"><a href="LocalStorageAdapter.html#_save">_save</a></li><li data-type="method" id="LocalStorageAdapter-check-nav"><a href="LocalStorageAdapter.html#check">check</a></li><li data-type="method" id="LocalStorageAdapter-create-nav"><a href="LocalStorageAdapter.html#create">create</a></li><li data-type="method" id="LocalStorageAdapter-decrypt-nav"><a href="LocalStorageAdapter.html#decrypt">decrypt</a></li><li data-type="method" id="LocalStorageAdapter-encrypt-nav"><a href="LocalStorageAdapter.html#encrypt">encrypt</a></li><li data-type="method" id="LocalStorageAdapter-generateIdentifier-nav"><a href="LocalStorageAdapter.html#generateIdentifier">generateIdentifier</a></li><li data-type="method" id="LocalStorageAdapter-load-nav"><a href="LocalStorageAdapter.html#load">load</a></li><li data-type="method" id="LocalStorageAdapter-save-nav"><a href="LocalStorageAdapter.html#save">save</a></li></ul></li><li id="MemoryStorageAdapter-nav"><a href="MemoryStorageAdapter.html">MemoryStorageAdapter</a><ul class='methods'><li data-type="method" id="MemoryStorageAdapter-_save-nav"><a href="MemoryStorageAdapter.html#_save">_save</a></li><li data-type="method" id="MemoryStorageAdapter-check-nav"><a href="MemoryStorageAdapter.html#check">check</a></li><li data-type="method" id="MemoryStorageAdapter-create-nav"><a href="MemoryStorageAdapter.html#create">create</a></li><li data-type="method" id="MemoryStorageAdapter-decrypt-nav"><a href="MemoryStorageAdapter.html#decrypt">decrypt</a></li><li data-type="method" id="MemoryStorageAdapter-encrypt-nav"><a href="MemoryStorageAdapter.html#encrypt">encrypt</a></li><li data-type="method" id="MemoryStorageAdapter-generateIdentifier-nav"><a href="MemoryStorageAdapter.html#generateIdentifier">generateIdentifier</a></li><li data-type="method" id="MemoryStorageAdapter-load-nav"><a href="MemoryStorageAdapter.html#load">load</a></li><li data-type="method" id="MemoryStorageAdapter-save-nav"><a href="MemoryStorageAdapter.html#save">save</a></li></ul></li><li id="OIP-nav"><a href="OIP.html">OIP</a><ul class='methods'><li data-type="method" id="OIP-getMultiparts-nav"><a href="OIP.html#getMultiparts">getMultiparts</a></li></ul></li><li id="StorageAdapter-nav"><a href="StorageAdapter.html">StorageAdapter</a><ul class='methods'><li data-type="method" id="StorageAdapter-check-nav"><a href="StorageAdapter.html#check">check</a></li><li data-type="method" id="StorageAdapter-create-nav"><a href="StorageAdapter.html#create">create</a></li><li data-type="method" id="StorageAdapter-decrypt-nav"><a href="StorageAdapter.html#decrypt">decrypt</a></li><li data-type="method" id="StorageAdapter-encrypt-nav"><a href="StorageAdapter.html#encrypt">encrypt</a></li><li data-type="method" id="StorageAdapter-generateIdentifier-nav"><a href="StorageAdapter.html#generateIdentifier">generateIdentifier</a></li><li data-type="method" id="StorageAdapter-load-nav"><a href="StorageAdapter.html#load">load</a></li><li data-type="method" id="StorageAdapter-save-nav"><a href="StorageAdapter.html#save">save</a></li></ul></li></ul><h3 id="global-nav"><a href="global.html">Global</a></h3>
  </nav>

  <div id="main">
    
      <h1 class="page-title">
        StorageAdapter.js
      </h1>
    

    
      

<section>
  <article>
    <pre class="prettyprint source linenums"><code>import CryptoJS from 'crypto-js';
import crypto from 'crypto';

import { isValidEmail, isValidIdentifier } from './util'

const AES_CONFIG = {
	mode: CryptoJS.mode.CTR,
	padding: CryptoJS.pad.Iso10126,
	iterations: 5
}

/**
 * A Unique identifier for the user. This is a set of characters seperated by dashes.
 * @typedef {string} Identifier
 * @example
 * e7c7a45-8aac7317-b2b0098-2c7a046
 */

/**
 * A Generic StorageAdapter class that provides shared functions between all StorageAdapters
 */
class StorageAdapter {
	/**
	 * Create a new Storage Adapter
	 * @param  {string} username - The username of the account you wish to use
	 * @param  {string} password - The password of the account you wish to use
	 * @return {StorageAdapter}
	 */
	constructor(username, password){
		this._username = username
		this._password = password || ""

		this.storage = {
			identifier: undefined,
			email: undefined,
			encrypted_data: ""
		}

		if (this._username &amp;&amp; !isValidIdentifier(this._username) &amp;&amp; isValidEmail(this._username))
			this.storage.email = this._username;

	}
	/**
	 * Create an account using the StorageAdapter
	 *
	 * @async
	 * @param  {Object} account_data - The Account Data you wish to save
	 * @param  {string} [email]      - The Email you wish to attach to your account
	 * @return {Promise&lt;Identifier>} The Identifier of the Created Account
	 */
	async create(account_data, email){
		var account_data_copy = JSON.parse(JSON.stringify(account_data));

		if (email){
			this.storage.email = email
			account_data_copy.email = email;

			if (!this._username)
				this._username = email
		} else {
			if (isValidEmail(this._username)){
				this.storage.email = this._username
				account_data_copy.email = this._username
			}
		}

		var identifier = this.generateIdentifier();

		account_data_copy.identifier = identifier;

		if (!this._username)
			this._username = identifier

		return await this.save(account_data_copy, identifier)
	}
	/**
	 * Save an Account using the StorageAdapter
	 *
	 * @async
	 * @param  {Object} account_data - The Account Data you wish to save
	 * @param  {Identifier} [identifier] - The Identifier of the Account you wish to save to
	 * @return {Promise&lt;Identifier>} Returns the Identifier of the saved account
	 */
	async save(account_data, identifier){
		if (identifier){
			return await this._save(account_data, identifier)
		} else {
			try {
				var id = await this.check()

				return await this._save(account_data, id)
			} catch(e) {
				if (this.storage.identifier &amp;&amp; e.response &amp;&amp; e.response.data &amp;&amp; e.response.data.type)
					throw new Error(e.response.data.type)

				// No ID, generate new and save
				return await this.create(account_data)
			}
		}
	}
	/**
	 * Load the Wallet from the StorageAdapter, this function is overwritten by sub-classes
	 *
	 * @async
	 * @return {Promise&lt;Object>} Returns the Account Data for the specified account
	 */
	async load(){}
	/**
	 * Check if the Wallet exists on the StorageAdapter, this function is overwritten by sub-classes
	 * @return {Promise&lt;Identifier>} Returns the Identifier of the matched wallet (if found)
	 */
	async check(){}
	/**
	 * Generate a valid Identifier
	 * @return {Identifier} Returns a newly generated identifier
	 */
	generateIdentifier() {
		var bytes = crypto.randomBytes(16).toString('hex')

		var identifier = bytes.slice(0, 7) + "-" + bytes.slice(8, 16) + "-" + bytes.slice(17, 24) + "-" + bytes.slice(25, 32)

		this.storage.identifier = identifier;

		return identifier
	}
	/**
	 * Decrypt the Account data
	 * @param  {string} encrypted_data - The Encrypted Data string to Decrypt
	 * @return {Object} Returns the decrypted data as a JSON Object  
	 */
	decrypt(encrypted_data){
		try {
			var decrypted = CryptoJS.AES.decrypt(encrypted_data, this._password, AES_CONFIG);
			var hydrated_decrypted = JSON.parse(decrypted.toString(CryptoJS.enc.Utf8))

			if (hydrated_decrypted &amp;&amp; hydrated_decrypted.email)
				this.storage.email = hydrated_decrypted.email

			if (hydrated_decrypted &amp;&amp; hydrated_decrypted.identifier)
				this.storage.identifier = hydrated_decrypted.identifier

			return hydrated_decrypted
		} catch (e) {
			return undefined
		}

		return undefined
	}
	/**
	 * Encrypt the Account data
	 * @param  {Object} decrypted_data - A JSON object of the data you would like to encrypt
	 * @return {string} Returns the Encrypted Data as a String
	 */
	encrypt(decrypted_data){
		if (decrypted_data &amp;&amp; !decrypted_data.email &amp;&amp; this.storage.email &amp;&amp; this.storage.email !== "")
			decrypted_data.email = this.storage.email

		if (decrypted_data &amp;&amp; !decrypted_data.identifier &amp;&amp; this.storage.identifier &amp;&amp; this.storage.identifier !== ""){
			decrypted_data.identifier = this.storage.identifier
		}

		try {
			var decrypted_string = JSON.stringify(decrypted_data);
			var encrypted = CryptoJS.AES.encrypt(decrypted_string, this._password, AES_CONFIG)
			var encrypted_string = encrypted.toString();

			this.storage.encrypted_data = encrypted_string;

			return encrypted_string
		} catch (e) {
			return undefined
		}

		return undefined
	}
}

module.exports = StorageAdapter;</code></pre>
  </article>
</section>

    


  </div>

  <br class="clear">

  <footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a>
  </footer>

  <script src="scripts/linenumber.js"></script>
  <script src="scripts/pagelocation.js"></script>

  
  
</body>
</html>
